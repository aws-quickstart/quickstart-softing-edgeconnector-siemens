AWSTemplateFormatVersion: '2010-09-09'
Description: AWS QuickStart Stack for Softing edgeConnector Siemens with S7 1200/1500
  protocol Simulator
Metadata:
  AWS::CloudFormation::Interface:

    ParameterGroups:
      - Label:
          default: AWS IoT SiteWise configuration
        Parameters:
          - SiteWiseMonitorCreation
      - Label:
          default: Network Configuration
        Parameters:
        - VPCID
        - PublicSubnet1ID
        - PublicSubnet2ID
      - Label:
          default: AWS Quick Start configuration
        Parameters:
          - QSS3BucketName
          - QSS3BucketRegion
          - QSS3KeyPrefix
    ParameterLabels:
      SiteWiseMonitorCreation:
        default: AWS IoT SiteWise Monitor and Dashboard creation for Telemetry visualization
      VPCID:
        default: VPC ID
      PublicSubnet1ID:
        default: Public Subnet 1 ID
      PublicSubnet2ID:
        default: Public Subnet 2 ID
      QSS3BucketName:
        default: Quick Start S3 bucket name
      QSS3BucketRegion:
        default: Quick Start S3 bucket region
      QSS3KeyPrefix:
        default: Quick Start S3 Key Prefix

Parameters:
  SiteWiseMonitorCreation:
    Type: String
    Default: 'Yes'
    AllowedValues:
      - 'Yes'
      - 'No'
    Description: Choose 'No' to skip creation of AWS IoT SiteWise Monitor/Dashboard
      setup. In this case telemetry data will be shown only in the Asset Measurements
      section
  VPCID:
    Type: AWS::EC2::VPC::Id
    Description: The ID of your existing VPC (e.g., vpc-0343606e).
  PublicSubnet1ID:
    Type: AWS::EC2::Subnet::Id
    Description: The ID of the public subnet in Availability Zone 1 in your existing VPC (e.g., subnet-a0246dcd).
  PublicSubnet2ID:
    Type: AWS::EC2::Subnet::Id
    Description: The ID of the public subnet in Availability Zone 2 in your existing VPC (e.g., subnet-b58c3d67).
  QSS3BucketName:
    AllowedPattern: ^[0-9a-zA-Z]+([0-9a-zA-Z-]*[0-9a-zA-Z])*$
    ConstraintDescription: Quick Start bucket name can include numbers, lowercase
      letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen
      (-).
    Default: aws-quickstart
    Description: S3 bucket name for the Quick Start assets. Quick Start bucket name
      can include numbers, lowercase letters, uppercase letters, and hyphens (-).
      It cannot start or end with a hyphen (-).
    Type: String
  QSS3BucketRegion:
    Default: eu-central-1
    Description: The AWS Region where the Quick Start S3 bucket (QSS3BucketName) is
      hosted. When using your own bucket, you must specify this value.
    Type: String
  QSS3KeyPrefix:
    AllowedPattern: ^[0-9a-zA-Z-/]*$
    ConstraintDescription: Quick Start key prefix can include numbers, lowercase letters,
      uppercase letters, hyphens (-), and forward slash (/).
    Default: quickstart-softing-edgeconnector-siemens/
    Description: S3 key prefix for the Quick Start assets. Quick Start key prefix
      can include numbers, lowercase letters, uppercase letters, hyphens (-), and
      forward slash (/).
    Type: String

Mappings:
  AWSInstanceType2Arch:
    t2.micro:
      Arch: HVM64
  AWSRegionArch2AMI:
    eu-central-1:
      HVM64: ami-0233214e13e500f77
    eu-west-1:
      HVM64: ami-d3c0c4b5
    us-west-2:
      HVM64: ami-4836a428
    us-east-1:
      HVM64: ami-0b33d91d

Conditions:
  ValidRegion: !Or
    - !Equals
      - !Ref 'AWS::Region'
      - eu-west-1
    - !Equals
      - !Ref 'AWS::Region'
      - us-west-2
    - !Equals
      - !Ref 'AWS::Region'
      - us-east-1
    - !Equals
      - !Ref 'AWS::Region'
      - eu-central-1
  CreateSiteWiseMonitorResources: !Equals
    - !Ref 'SiteWiseMonitorCreation'
    - 'Yes'
  SiteWiseConditions: !And
    - !Condition 'ValidRegion'
    - !Condition 'CreateSiteWiseMonitorResources'

Resources:
  ClassicLoadBalancer:
    Type: AWS::ElasticLoadBalancing::LoadBalancer
    Properties:
      LoadBalancerName: 'SoftingEdgeConnectorSiemens'
      Scheme: internet-facing
      Listeners:
        - InstancePort: '8099'
          InstanceProtocol: HTTP
          LoadBalancerPort: '80'
          Protocol: HTTP
        - InstancePort: '4897'
          InstanceProtocol: TCP
          LoadBalancerPort: '4897'
          Protocol: TCP
      HealthCheck:
        Target: HTTP:8099/
        HealthyThreshold: '2'
        UnhealthyThreshold: '3'
        Interval: '10'
        Timeout: '5'
      Subnets:
        - !Ref PublicSubnet1ID
        - !Ref PublicSubnet2ID
      SecurityGroups:
        - !GetAtt 'LoadBalancerSecurityGroup.GroupId'
  LoadBalancerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Enable standard HTTP access via port 80 and default OPC UA/TCP
        endpoint access via 4897
      VpcId: !Ref VPCID
      SecurityGroupIngress:
        - IpProtocol: tcp
          CidrIp: '0.0.0.0/0'
          FromPort: 80
          ToPort: 80
        - IpProtocol: tcp
          CidrIp: '0.0.0.0/0'
          FromPort: 4897
          ToPort: 4897
      SecurityGroupEgress:
        - IpProtocol: '-1'
          FromPort: -1
          ToPort: -1
          CidrIp: '0.0.0.0/0'
  EC2LaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: !Sub '${AWS::StackName}-Launch-Template'
      LaunchTemplateData:
        ImageId: !FindInMap
          - AWSRegionArch2AMI
          - !Ref 'AWS::Region'
          - !FindInMap
            - AWSInstanceType2Arch
            - t2.micro
            - Arch
        InstanceType: t2.micro
        SecurityGroupIds:
          - !GetAtt 'EC2InstanceSecurityGroup.GroupId'
        IamInstanceProfile:
          Arn: !GetAtt 'EC2InstanceProfile.Arn'
        UserData: !Base64
          Fn::Join:
            - ''
            - - "#!/bin/bash -x\n"
              - "cd /home/ec2-user/\n"
              - "mkdir -p .aws\n"
              - 'echo -e ''[default]\nregion = '
              - !Ref 'AWS::Region'
              - "\\n' > .aws/config\n"
              - "sudo chown -R ec2-user:ec2-user .aws\n"
              - "sudo yum remove -y aws-cli java*\n"
              - "sudo yum update -y\n"
              - "sudo yum install -y wget tree docker ecs-init java-1.8.0-openjdk\n"
              - "curl \"https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip\"\
                \ -o \"awscliv2.zip\"\n"
              - "unzip awscliv2.zip 1>/dev/null\n"
              - "sudo ./aws/install\n"
              - "sudo ln -s /usr/local/bin/aws /usr/bin/aws\n"
              - "sudo service docker start\n"
              - "sudo usermod -a -G docker ec2-user\n"
              - "sudo adduser --system ggc_user\n"
              - "sudo groupadd --system ggc_group\n"
              - "curl https://raw.githubusercontent.com/tianon/cgroupfs-mount/951c38ee8d802330454bdede20d85ec1c0f8d312/cgroupfs-mount\
                \ > cgroupfs-mount.sh\n"
              - "chmod +x cgroupfs-mount.sh\n"
              - "sudo bash ./cgroupfs-mount.sh\n"
              - echo ECS_CLUSTER=
              - !Ref 'ECSCluster'
              - " | sudo tee -a /etc/ecs/ecs.config\n"
              - "echo 'fs.protected_hardlinks = 1' | sudo tee -a /etc/sysctl.conf\n"
              - "echo 'fs.protected_symlinks = 1' | sudo tee -a /etc/sysctl.conf\n"
              - "echo 'net.ipv4.ip_forward = 1' | sudo tee -a /etc/sysctl.conf\n"
              - "sudo sysctl -p\n"
              - "wget https://d1onfpft10uf5o.cloudfront.net/greengrass-core/downloads/1.11.0/greengrass-linux-x86-64-1.11.0.tar.gz\n"
              - "sudo tar -xvzf greengrass-linux-x86-64-1.11.0.tar.gz -C /\n"
              - "sudo wget -O /greengrass/certs/root.ca.pem https://www.amazontrust.com/repository/AmazonRootCA1.pem\n"
              - echo -n '
              - !GetAtt 'IoTThing.certificatePem'
              - ''' | sudo tee -a /greengrass/certs/'
              - !GetAtt 'IoTThing.certificateId'
              - ".pem\n"
              - echo -n '
              - !GetAtt 'IoTThing.privateKey'
              - ''' | sudo tee -a /greengrass/certs/'
              - !GetAtt 'IoTThing.certificateId'
              - ".key\n"
              - "sudo mkdir -p /var/sitewise\n"
              - "sudo chown ggc_user /var/sitewise\n"
              - "sudo chmod 700 /var/sitewise\n"
              - "cat <<EOT > config.json\n"
              - "{\n"
              - "    \"coreThing\" : {\n"
              - "      \"caPath\" : \"root.ca.pem\",\n"
              - '      "certPath" : "'
              - !GetAtt 'IoTThing.certificateId'
              - ".pem\",\n"
              - '      "keyPath" : "'
              - !GetAtt 'IoTThing.certificateId'
              - ".key\",\n"
              - '      "thingArn" : "arn:aws:iot:'
              - !Ref 'AWS::Region'
              - ':'
              - !Ref 'AWS::AccountId'
              - :thing/
              - !Ref 'AWS::StackName'
              - "_Core\",\n"
              - '      "iotHost" : "'
              - !GetAtt 'IoTThing.iotEndpoint'
              - "\",\n"
              - '      "ggHost" : "greengrass-ats.iot.'
              - !Ref 'AWS::Region'
              - ".amazonaws.com\"\n"
              - "    },\n"
              - "    \"runtime\" : {\n"
              - "      \"cgroup\" : {\n"
              - "         \"useSystemd\" : \"yes\"\n"
              - "       }\n"
              - "     },\n"
              - "    \"managedRespawn\" : false,\n"
              - "    \"crypto\" : {\n"
              - "      \"principals\" : {\n"
              - "       \"SecretsManager\" : {\n"
              - '         "privateKeyPath" : "file:///greengrass/certs/'
              - !GetAtt 'IoTThing.certificateId'
              - ".key\"\n"
              - "        },\n"
              - "       \"IoTCertificate\" : {\n"
              - '        "privateKeyPath" : "file:///greengrass/certs/'
              - !GetAtt 'IoTThing.certificateId'
              - ".key\",\n"
              - '         "certificatePath" : "file:///greengrass/certs/'
              - !GetAtt 'IoTThing.certificateId'
              - ".pem\"\n"
              - "         }\n"
              - "        },\n"
              - "       \"caPath\" : \"file:///greengrass/certs/root.ca.pem\"\n"
              - "    }\n"
              - "}\n"
              - "EOT\n"
              - "sudo mv config.json /greengrass/config/\n"
              - "sudo chown root /greengrass/config/config.json\n"
              - "sudo /greengrass/ggc/core/greengrassd start\n"
              - GateWay_ID=`aws iotsitewise list-gateways --query 'gatewaySummaries[?gatewayName==\`
              - !Ref 'AWS::StackName'
              - '_Gateway\`].gatewayId'' --output text --region '
              - !Ref 'AWS::Region'
              - "` && export GateWay_ID\n"
              - "aws iotsitewise delete-gateway --gateway-id ${GateWay_ID//\\\"}\n"
              - 'aws iotsitewise create-gateway --gateway-name '
              - !Ref 'AWS::StackName'
              - _Gateway --gateway-platform greengrass={groupArn=
              - !GetAtt 'GreengrassGroup.Arn'
              - "}\n"
              - GateWay_ID=`aws iotsitewise list-gateways --query 'gatewaySummaries[?gatewayName==\`
              - !Ref 'AWS::StackName'
              - '_Gateway\`].gatewayId'' --output text --region '
              - !Ref 'AWS::Region'
              - "` && export GateWay_ID\n"
              - "cat <<EOT > gateway_config.json\n"
              - "{\n"
              - "  \"sources\":\n"
              - "        [\n"
              - "            {\n"
              - '              "name":"'
              - !Ref 'AWS::StackName'
              - "_S7Simulator\",\n"
              - "              \"endpoint\": {\n"
              - "                \"certificateTrust\": {\n"
              - "                  \"type\": \"TrustAny\"\n"
              - "                },\n"
              - '                "endpointUri": "'
              - !Join
                - ''
                - - opc.tcp://localhost:4897/Softing/dataFEED/Server
              - "\",\n"
              - "                \"securityPolicy\": \"NONE\",\n"
              - "                \"messageSecurityMode\": \"NONE\",\n"
              - "                  \"identityProvider\": {\n"
              - "                  \"type\": \"Username\",\n"
              - '                      "usernameSecretArn": "'
              - !Ref 'GreengrassSiteWiseUASecretPassword'
              - "\"\n"
              - "                 },\n"
              - "                 \"nodeFilterRules\": [\n"
              - "                     {\n"
              - "                         \"action\": \"INCLUDE\",\n"
              - "                         \"definition\": {\n"
              - "                           \"type\": \"OpcUaRootPath\",\n"
              - "                           \"rootPath\": \"/S7-Sim/DataBlocks/Datatypes_All\"\
                \n"
              - "                         }\n"
              - "                     }\n"
              - "                 ]\n"
              - "              },\n"
              - '             "measurementDataStreamPrefix": "'
              - !Ref 'AWS::StackName'
              - "\"\n"
              - "            }\n"
              - "        ]\n"
              - "}\n"
              - "EOT\n"
              - 'GroupVersion_ID=`aws greengrass list-group-versions --group-id '
              - !GetAtt 'GreengrassGroup.Id'
              - ' --query ''reverse(sort_by(Versions, &CreationTimestamp))[0].Version''
                --region '
              - !Ref 'AWS::Region'
              - "` && export GroupVersion_ID\n"
              - 'aws greengrass create-deployment --deployment-type NewDeployment
                --group-id '
              - !GetAtt 'GreengrassGroup.Id'
              - ' --group-version-id ${GroupVersion_ID//\"} --region '
              - !Ref 'AWS::Region'
              - "\n"

              - "aws s3 cp s3://"
              - !Ref 'QSS3BucketName' 
              - '/' 
              - !Ref 'QSS3KeyPrefix'
              - 'configs/ecconf.zip ./ecconf.zip'
              - "\n"

              - "unzip ecconf.zip 1>/dev/null\n"
              - "sudo start ecs\n"
              - "sleep 10s\n"
              - 'aws ecs run-task --launch-type EC2 --cluster '
              - !Ref 'ECSCluster'
              - ' --task-definition '
              - !Ref 'ECSTaskDefinition'
              - ' --region '
              - !Ref 'AWS::Region'
              - "\n"
              - "sleep 5s\n"
              - "aws iotsitewise update-gateway-capability-configuration --gateway-id\
                \ ${GateWay_ID//\\\"} --capability-namespace \"iotsitewise:opcuacollector:1\"\
                \ --capability-configuration file://gateway_config.json --region "
              - !Ref 'AWS::Region'
              - "\n"
              - "ls -al \n"
  EC2AutoScalingGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      AutoScalingGroupName: !Sub '${AWS::StackName}-Autoscaling-Group'
      MinSize: '1'
      MaxSize: '1'
      DesiredCapacity: '1'
      LaunchTemplate:
        LaunchTemplateId: !Ref 'EC2LaunchTemplate'
        Version: !GetAtt 'EC2LaunchTemplate.LatestVersionNumber'
      LoadBalancerNames:
        - !Ref 'ClassicLoadBalancer'
      VPCZoneIdentifier:
        - !Ref PublicSubnet1ID
        - !Ref PublicSubnet2ID
  IoTSiteWiseAssetModel:
    Type: AWS::IoTSiteWise::AssetModel
    Condition: ValidRegion
    Properties:
      AssetModelName: !Sub '${AWS::StackName}S7SimModel'
      AssetModelDescription: This is an asset model used in the IoT SiteWise.
      AssetModelProperties:
        - Name: Motor Sound Sine Wave with Noise
          DataType: DOUBLE
          Unit: Radian
          Type:
            TypeName: Measurement
          LogicalId: f9a16d95-b9d1-463f-9562-bf9bc71c6373
        - Name: Number of Products
          DataType: INTEGER
          Unit: Number
          Type:
            TypeName: Measurement
          LogicalId: 806e706c-1d78-4316-8582-3e191932455b
        - Name: Torque
          DataType: INTEGER
          Unit: Number
          Type:
            TypeName: Measurement
          LogicalId: 11a0d2ee-f8f8-4f02-a12b-20151d9bd989
        - Name: Oxygen Level
          DataType: INTEGER
          Unit: Number
          Type:
            TypeName: Measurement
          LogicalId: 4e2e808a-8252-4865-89d3-84002df3e5aa
  IoTSiteWiseAsset:
    Type: AWS::IoTSiteWise::Asset
    Condition: ValidRegion
    Properties:
      AssetName: !Sub '${AWS::StackName}S7SimAsset'
      AssetModelId: !Ref 'IoTSiteWiseAssetModel'
      AssetProperties:
        - LogicalId: f9a16d95-b9d1-463f-9562-bf9bc71c6373
          Alias: !Join
            - ''
            - - !Ref 'AWS::StackName'
              - /S7-Sim/DataBlocks/Datatypes_All/Real
          NotificationState: ENABLED
        - LogicalId: 806e706c-1d78-4316-8582-3e191932455b
          Alias: !Join
            - ''
            - - !Ref 'AWS::StackName'
              - /S7-Sim/DataBlocks/Datatypes_All/Integer
          NotificationState: ENABLED
        - LogicalId: 11a0d2ee-f8f8-4f02-a12b-20151d9bd989
          Alias: !Join
            - ''
            - - !Ref 'AWS::StackName'
              - /S7-Sim/DataBlocks/Datatypes_All/SInt
          NotificationState: ENABLED
        - LogicalId: 4e2e808a-8252-4865-89d3-84002df3e5aa
          Alias: !Join
            - ''
            - - !Ref 'AWS::StackName'
              - /S7-Sim/DataBlocks/Datatypes_All/UInt
          NotificationState: ENABLED
  IoTSiteWiseDashboard:
    Type: AWS::IoTSiteWise::Dashboard
    Condition: SiteWiseConditions
    Properties:
      DashboardDefinition: !Join
        - ''
        - - "{\n"
          - "\"widgets\": [\n"
          - "    {\n"
          - "        \"type\": \"monitor-line-chart\",\n"
          - "        \"title\": \"Motor Sound Sine Wave\",\n"
          - "        \"x\": 0,\n"
          - "        \"y\": 0,\n"
          - "        \"height\": 3,\n"
          - "        \"width\": 3,\n"
          - "        \"metrics\": [\n"
          - "            {\n"
          - "                \"label\": \"MotorSound_SineWithNoise\",\n"
          - "                \"type\": \"iotsitewise\",\n"
          - '                "assetId": "'
          - !Ref 'IoTSiteWiseAsset'
          - "\",\n"
          - "                \"propertyId\": \"f9a16d95-b9d1-463f-9562-bf9bc71c6373\"\
            \n"
          - "            }\n"
          - "        ]\n"
          - "    },\n"
          - "    {\n"
          - "        \"type\": \"monitor-line-chart\",\n"
          - "        \"title\": \"Number of Products\",\n"
          - "        \"x\": 0,\n"
          - "        \"y\": 3,\n"
          - "        \"height\": 3,\n"
          - "        \"width\": 3,\n"
          - "        \"metrics\": [\n"
          - "            {\n"
          - "                \"label\": \"NumberOfProducts_IncrementalInteger\",\n"
          - "                \"type\": \"iotsitewise\",\n"
          - '                "assetId": "'
          - !Ref 'IoTSiteWiseAsset'
          - "\",\n"
          - "                \"propertyId\": \"806e706c-1d78-4316-8582-3e191932455b\"\
            \n"
          - "            }\n"
          - "        ]\n"
          - "    },\n"
          - "    {\n"
          - "        \"type\": \"monitor-line-chart\",\n"
          - "        \"title\": \"Torque\",\n"
          - "        \"x\": 3,\n"
          - "        \"y\": 0,\n"
          - "        \"height\": 3,\n"
          - "        \"width\": 3,\n"
          - "        \"metrics\": [\n"
          - "            {\n"
          - "                \"label\": \"Torque_SawtoothInteger\",\n"
          - "                \"type\": \"iotsitewise\",\n"
          - '                "assetId": "'
          - !Ref 'IoTSiteWiseAsset'
          - "\",\n"
          - "                \"propertyId\": \"11a0d2ee-f8f8-4f02-a12b-20151d9bd989\"\
            \n"
          - "            }\n"
          - "        ]\n"
          - "    },\n"
          - "    {\n"
          - "        \"type\": \"monitor-line-chart\",\n"
          - "        \"title\": \"Oxygen Level\",\n"
          - "        \"x\": 3,\n"
          - "        \"y\": 3,\n"
          - "        \"height\": 3,\n"
          - "        \"width\": 3,\n"
          - "        \"metrics\": [\n"
          - "            {\n"
          - "                \"label\": \"Oxygen_RandomInteger\",\n"
          - "                \"type\": \"iotsitewise\",\n"
          - '                "assetId": "'
          - !Ref 'IoTSiteWiseAsset'
          - "\",\n"
          - "                \"propertyId\": \"4e2e808a-8252-4865-89d3-84002df3e5aa\"\
            \n"
          - "            }\n"
          - "        ]\n"
          - "    }\n"
          - "]\n}\n"
      DashboardDescription: IoT SiteWise Dashboard for Softing edgeConnector Siemens
        with PLC Simulator
      DashboardName: !Join
        - ''
        - - !Ref 'AWS::StackName'
          - _Dashboard
      ProjectId: !Ref 'IoTSiteWiseProject'
  IoTSiteWisePortal:
    Type: AWS::IoTSiteWise::Portal
    Condition: SiteWiseConditions
    Properties:
      PortalContactEmail: info@softing.com
      PortalDescription: IoT SiteWise Portal for Softing edgeConnector Siemens with
        PLC Simulator
      PortalName: !Join
        - ''
        - - !Ref 'AWS::StackName'
          - _Portal
      RoleArn: !GetAtt 'IoTSiteWiseMonitorRole.Arn'
  IoTSiteWiseProject:
    Type: AWS::IoTSiteWise::Project
    Condition: SiteWiseConditions
    Properties:
      PortalId: !Ref 'IoTSiteWisePortal'
      ProjectDescription: IoT SiteWise Project for Softing edgeConnector Siemens with
        PLC Simulator
      ProjectName: !Join
        - ''
        - - !Ref 'AWS::StackName'
          - _Project
  IoTSiteWiseMonitorRole:
    Type: AWS::IAM::Role
    Condition: SiteWiseConditions
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - monitor.iotsitewise.amazonaws.com
            Action:
              - sts:AssumeRole
      Path: /
      Policies:
        - PolicyName: !Join
            - ''
            - - !Ref 'AWS::StackName'
              - SiteWiseMonitorPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              Effect: Allow
              Action:
                - iotsitewise:*
                - sso-directory:*
                - iam:PassRole
              Resource: '*'
  GreengrassGroup:
    Type: AWS::Greengrass::Group
    Properties:
      Name: !Join
        - _
        - - !Ref 'AWS::StackName'
          - GreengrassGroup
      RoleArn: !GetAtt 'GreengrassGroupRole.Arn'
  GreengrassGroupVersion:
    Type: AWS::Greengrass::GroupVersion
    Properties:
      GroupId: !GetAtt 'GreengrassGroup.Id'
      CoreDefinitionVersionArn: !Ref 'GreengrassCoreDefinitionVersion'
      ConnectorDefinitionVersionArn: !Ref 'GreengrassConnectorDefinitionVersion'
      FunctionDefinitionVersionArn: !Ref 'GreengrassFunctionDefinitionVersion'
      ResourceDefinitionVersionArn: !Ref 'GreengrassSiteWiseUASecretResourceVersion'
  GreengrassFunctionDefinition:
    Type: AWS::Greengrass::FunctionDefinition
    Properties:
      Name: !Join
        - _
        - - !Ref 'AWS::StackName'
          - GreengrassFunctionDefinition
  GreengrassFunctionDefinitionVersion:
    Type: AWS::Greengrass::FunctionDefinitionVersion
    Properties:
      FunctionDefinitionId: !GetAtt 'GreengrassFunctionDefinition.Id'
      DefaultConfig:
        Execution:
          IsolationMode: NoContainer
      Functions:
        - FunctionArn: arn:aws:lambda:::function:GGStreamManager:1
          Id: StreamManagerFunctionDefinition
          FunctionConfiguration:
            Pinned: true
            Timeout: 5
        - FunctionArn: arn:aws:lambda:::function:GGIPDetector:1
          Id: AutomaticIPDetectionFunction
          FunctionConfiguration:
            Pinned: true
            Timeout: 5
  GreengrassConnectorDefinition:
    Type: AWS::Greengrass::ConnectorDefinition
    Properties:
      Name: !Join
        - _
        - - !Ref 'AWS::StackName'
          - GreengrassConnectorDefinition
  GreengrassConnectorDefinitionVersion:
    Type: AWS::Greengrass::ConnectorDefinitionVersion
    Properties:
      ConnectorDefinitionId: !Ref 'GreengrassConnectorDefinition'
      Connectors:
        - ConnectorArn: !Join
            - ''
            - - 'arn:aws:greengrass:'
              - !Ref 'AWS::Region'
              - ::/connectors/IoTSiteWise/versions/9
          Id: !Join
            - _
            - - !Ref 'AWS::StackName'
              - IoTSiteWiseConnector
          Parameters:
            AWSSecretsArnList: !Join
              - ''
              - - '["'
                - !Ref 'GreengrassSiteWiseUASecretPassword'
                - '"]'
  GreengrassSiteWiseUASecretPassword:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Join
        - ''
        - - greengrass-
          - !Ref 'AWS::StackName'
          - _edgeConnectorEndpointCredentials
      Description: Password for the edgeConnector Siemens Simulator endpoint, used
        by SiteWise
      SecretString: '{"username":"admin","password":"admin"}'
  GreengrassSiteWiseUASecretResource:
    Type: AWS::Greengrass::ResourceDefinition
    Properties:
      Name: !Join
        - _
        - - !Ref 'AWS::StackName'
          - edgeConnectorEndpointCredentialsResource
  GreengrassSiteWiseUASecretResourceVersion:
    Type: AWS::Greengrass::ResourceDefinitionVersion
    Properties:
      ResourceDefinitionId: !Ref 'GreengrassSiteWiseUASecretResource'
      Resources:
        - Id: !Join
            - _
            - - !Ref 'AWS::StackName'
              - SecretResourceId
          Name: SecretsManagerSecretResourceData
          ResourceDataContainer:
            SecretsManagerSecretResourceData:
              ARN: !Ref 'GreengrassSiteWiseUASecretPassword'
  GreengrassGroupRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: greengrass.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: !Sub '${AWS::StackName}GreengrassGroupPolicy'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: arn:aws:logs:*:*:*
              - Effect: Allow
                Action: iotsitewise:BatchPutAssetPropertyValue
                Resource: '*'
              - Effect: Allow
                Action:
                  - iot:*
                Resource: '*'
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                Resource: '*'
  GreengrassCoreDefinition:
    Type: AWS::Greengrass::CoreDefinition
    Properties:
      Name: !Join
        - _
        - - !Ref 'AWS::StackName'
          - Core
  GreengrassCoreDefinitionVersion:
    Type: AWS::Greengrass::CoreDefinitionVersion
    Properties:
      CoreDefinitionId: !Ref 'GreengrassCoreDefinition'
      Cores:
        - Id: !Join
            - _
            - - !Ref 'AWS::StackName'
              - Core
          ThingArn: !Join
            - ':'
            - - arn:aws:iot
              - !Ref 'AWS::Region'
              - !Ref 'AWS::AccountId'
              - !Join
                - /
                - - thing
                  - !Join
                    - _
                    - - !Ref 'AWS::StackName'
                      - Core
          CertificateArn: !Join
            - ':'
            - - arn:aws:iot
              - !Ref 'AWS::Region'
              - !Ref 'AWS::AccountId'
              - !Join
                - /
                - - cert
                  - !GetAtt 'IoTThing.certificateId'
          SyncShadow: false
  IoTThing:
    Type: Custom::IoTThing
    Properties:
      ServiceToken: !GetAtt 'CreateThingFunction.Arn'
      ThingName: !Join
        - _
        - - !Ref 'AWS::StackName'
          - Core
  CreateThingFunction:
    Type: AWS::Lambda::Function
    Properties:
      Description: Create thing, certificate, and policy, return cert and private
        key
      Handler: index.handler
      Runtime: python3.6
      Role: !GetAtt 'LambdaExecutionRole.Arn'
      Timeout: 60
      Code:
        ZipFile: !Join
          - "\n"
          - - import sys
            - import cfnresponse
            - import boto3
            - from botocore.exceptions import ClientError
            - import json
            - import logging
            - logger = logging.getLogger()
            - logger.setLevel(logging.INFO)
            - ''
            - policyDocument = {
            - '    ''Version'': ''2012-10-17'','
            - '    ''Statement'': ['
            - '        {'
            - '            ''Effect'': ''Allow'','
            - '            ''Action'': ''iot:*'','
            - '            ''Resource'': ''*'''
            - '        },'
            - '        {'
            - '            ''Effect'': ''Allow'','
            - '            ''Action'': ''greengrass:*'','
            - '            ''Resource'': ''*'''
            - '        }'
            - '    ]'
            - '}'
            - ''
            - ''
            - 'def handler(event, context):'
            - '    responseData = {}'
            - '    try:'
            - '        logger.info(''Received event: {}''.format(json.dumps(event)))'
            - '        result = cfnresponse.FAILED'
            - '        client = boto3.client(''iot'')'
            - '        thingName=event[''ResourceProperties''][''ThingName'']'
            - '        if event[''RequestType''] == ''Create'':'
            - '           thing = client.create_thing('
            - '           thingName=thingName'
            - '           )'
            - '           response = client.create_keys_and_certificate('
            - '               setAsActive=True'
            - '               )'
            - '           certId = response[''certificateId'']'
            - '           certArn = response[''certificateArn'']'
            - '           certPem = response[''certificatePem'']'
            - '           privateKey = response[''keyPair''][''PrivateKey'']'
            - '           client.create_policy('
            - '               policyName=''{}-full-access''.format(thingName),'
            - '               policyDocument=json.dumps(policyDocument)'
            - '               )'
            - '           response = client.attach_policy('
            - '               policyName=''{}-full-access''.format(thingName),'
            - '               target=certArn'
            - '               )'
            - '           response = client.attach_thing_principal('
            - '               thingName=thingName,'
            - '               principal=certArn,'
            - '               )'
            - '           logger.info(''Created thing: %s, cert: %s and policy: %s''
              %'
            - '               (thingName, certId, ''{}-full-access''.format(thingName)))'
            - '           result = cfnresponse.SUCCESS'
            - '           responseData[''certificateId''] = certId'
            - '           responseData[''certificatePem''] = certPem'
            - '           responseData[''privateKey''] = privateKey'
            - '           responseData[''iotEndpoint''] = client.describe_endpoint(endpointType=''iot:Data-ATS'')[''endpointAddress'']'
            - '        elif event[''RequestType''] == ''Update'':'
            - '           logger.info(''Updating thing: %s'' % thingName)'
            - '           result = cfnresponse.SUCCESS'
            - '        elif event[''RequestType''] == ''Delete'':'
            - '           logger.info(''Deleting thing: %s and cert/policy'' % thingName)'
            - '           response = client.list_thing_principals('
            - '               thingName=thingName'
            - '               )'
            - '           for i in response[''principals'']:'
            - '               response = client.detach_thing_principal('
            - '               thingName=thingName,'
            - '               principal=i'
            - '               )'
            - '               response = client.detach_policy('
            - '                   policyName=''{}-full-access''.format(thingName),'
            - '                   target=i'
            - '                   )'
            - '               response = client.update_certificate('
            - '                   certificateId=i.split(''/'')[-1],'
            - '                   newStatus=''INACTIVE'''
            - '                   )'
            - '               response = client.delete_certificate('
            - '                   certificateId=i.split(''/'')[-1],'
            - '                   forceDelete=True'
            - '                   )'
            - '           response = client.delete_policy('
            - '               policyName=''{}-full-access''.format(thingName),'
            - '               )'
            - '           response = client.delete_thing('
            - '               thingName=thingName'
            - '               )'
            - '           result = cfnresponse.SUCCESS'
            - '    except ClientError as e:'
            - '        logger.error(''Error: {}''.format(e))'
            - '        result = cfnresponse.FAILED'
            - '    logger.info(''Returning response of: {}, with result of: {}''.format(result,
              responseData))'
            - '    sys.stdout.flush()'
            - '    cfnresponse.send(event, context, result, responseData)'
  GroupDeploymentReset:
    Type: Custom::GroupDeploymentReset
    DependsOn: GreengrassGroup
    Properties:
      ServiceToken: !GetAtt 'GroupDeploymentResetFunction.Arn'
      Region: !Ref 'AWS::Region'
      ThingName: !Join
        - _
        - - !Ref 'AWS::StackName'
          - Core
  GroupDeploymentResetFunction:
    Type: AWS::Lambda::Function
    DependsOn: GreengrassGroup
    Properties:
      Description: Resets any deployments during stack delete and manages Greengrass
        service role needs
      Handler: index.handler
      Runtime: python3.6
      Role: !GetAtt 'LambdaExecutionRole.Arn'
      Timeout: 60
      Environment:
        Variables:
          STACK_NAME: !Ref 'AWS::StackName'
      Code:
        ZipFile: !Join
          - "\n"
          - - import os
            - import sys
            - import json
            - import logging
            - import cfnresponse
            - import boto3
            - from botocore.exceptions import ClientError
            - ''
            - lgr = logging.getLogger()
            - lgr.setLevel(logging.INFO)
            - ''
            - c = boto3.client('greengrass')
            - iam = boto3.client('iam')
            - role_name = 'greengrass_cfn_{}_ServiceRole'.format(os.environ['STACK_NAME'])
            - policy_arn = 'arn:aws:iam::aws:policy/service-role/AWSGreengrassResourceAccessRolePolicy'
            - ''
            - 'def find_group(thingName):'
            - '    res_auth = '''''
            - '    response = c.list_groups()'
            - '    for grp in response[''Groups'']:'
            - '        thingfound = False'
            - '        group_version = c.get_group_version('
            - '            GroupId=grp[''Id''], GroupVersionId=grp[''LatestVersion'']'
            - '        )'
            - ''
            - '        core_arn = group_version[''Definition''].get(''CoreDefinitionVersionArn'',
              '''')'
            - '        if core_arn:'
            - '            core_id = core_arn['
            - '                core_arn.index(''/cores/'') + 7 : core_arn.index(''/versions/'')'
            - '            ]'
            - '            core_version_id = core_arn['
            - '                core_arn.index(''/versions/'') + 10 : len(core_arn)'
            - '            ]'
            - '            thingfound = False'
            - '            response_core_version = c.get_core_definition_version('
            - '                CoreDefinitionId=core_id, CoreDefinitionVersionId=core_version_id'
            - '            )'
            - '            if ''Cores'' in response_core_version[''Definition'']:'
            - '                for thing_arn in response_core_version[''Definition''][''Cores'']:'
            - '                    if thingName == thing_arn[''ThingArn''].split(''/'')[1]:'
            - '                        thingfound = True'
            - '                        break'
            - '        if thingfound:'
            - '            lgr.info(''found thing: %s, group id is: %s'' % (thingName,
              grp[''Id'']))'
            - '            res_auth = grp[''Id'']'
            - '            return res_auth'
            - ''
            - ''
            - 'def manage_role(cmd):'
            - '    if cmd == ''CREATE'':'
            - '        r = iam.create_role('
            - '            RoleName=role_name,'
            - '            AssumeRolePolicyDocument=''{"Version": "2012-10-17","Statement":
              [{"Effect": "Allow","Principal": {"Service": "greengrass.amazonaws.com"},"Action":
              "sts:AssumeRole"}]}'','
            - '            Description=''CFN blog post'','
            - '        )'
            - '        role_arn = r[''Role''][''Arn'']'
            - '        iam.attach_role_policy('
            - '            RoleName=role_name,'
            - '            PolicyArn=policy_arn,'
            - '        )'
            - '        c.associate_service_role_to_account(RoleArn=role_arn)'
            - '        lgr.info(''Created/assoc role {}''.format(role_name))'
            - '    else:'
            - '        try:'
            - '            r = iam.get_role(RoleName=role_name)'
            - '            role_arn = r[''Role''][''Arn'']'
            - '            c.disassociate_service_role_from_account()'
            - '            iam.detach_role_policy('
            - '                RoleName=role_name,'
            - '                PolicyArn=policy_arn,'
            - '            )'
            - '            iam.delete_role(RoleName=role_name)'
            - '            lgr.info(''Deleted service role {}''.format(role_name))'
            - '        except ClientError as e:'
            - '            lgr.error(''No service role to delete: %s'' % e)'
            - '            return True'
            - '    return True'
            - ''
            - 'def handler(event, context):'
            - '    responseData = {}'
            - '    try:'
            - '        lgr.info(''Received event: {}''.format(json.dumps(event)))'
            - '        res = cfnresponse.FAILED'
            - '        thingName = event[''ResourceProperties''][''ThingName'']'
            - '        if event[''RequestType''] == ''Create'':'
            - '            try:'
            - '                c.get_service_role_for_account()'
            - '                res = cfnresponse.SUCCESS'
            - '            except ClientError as e:'
            - '                manage_role(''CREATE'')'
            - '                lgr.info(''GG service role created'')'
            - '                res = cfnresponse.SUCCESS'
            - '        elif event[''RequestType''] == ''Delete'':'
            - '            gid = find_group(thingName)'
            - '            lgr.info(''Group id to delete: %s'' % gid)'
            - '            if gid:'
            - '                c.reset_deployments(Force=True, GroupId=gid)'
            - '                lgr.info(''Forced reset of deployment'')'
            - '                if manage_role(''DELETE''):'
            - '                    res = cfnresponse.SUCCESS'
            - '                    lgr.info(''Service role deleted'')'
            - '            else:'
            - '                lgr.error(''No group: %s found'' % thingName)'
            - '    except ClientError as e:'
            - '        lgr.error(''Error: %s'' % e)'
            - '        res = cfnresponse.FAILED'
            - '    lgr.info(''Response of: %s, with result of: %s'' % (res, responseData))'
            - '    sys.stdout.flush()'
            - '    cfnresponse.send(event, context, res, responseData)'
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: !Sub '${AWS::StackName}LambdaExecutionPolicy'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: arn:aws:logs:*:*:*
              - Effect: Allow
                Action:
                  - iot:*
                Resource: '*'
              - Effect: Allow
                Action:
                  - greengrass:*
                Resource: '*'
              - Effect: Allow
                Action:
                  - ec2:DescribeReservedInstancesOfferings
                Resource: '*'
              - Effect: Allow
                Action:
                  - iam:CreateRole
                  - iam:AttachRolePolicy
                  - iam:DetachRolePolicy
                  - iam:GetRole
                  - iam:DeleteRole
                  - iam:PassRole
                Resource: !Join
                  - ''
                  - - 'arn:aws:iam::'
                    - !Ref 'AWS::AccountId'
                    - :role/greengrass_cfn_
                    - !Ref 'AWS::StackName'
                    - _ServiceRole

  EC2InstanceSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Enable SSH access via port 22, Greengrass/MQTT access via
        port 8883, edgeConnector Siemens access via port 8099 and 1443, and default
        UA endpoint access via 4897
      VpcId: !Ref VPCID
      SecurityGroupIngress:
        - IpProtocol: tcp
          CidrIp: '0.0.0.0/0'
          FromPort: 22
          ToPort: 22
        - IpProtocol: tcp
          CidrIp: '0.0.0.0/0'
          FromPort: 8883
          ToPort: 8883
        - IpProtocol: tcp
          CidrIp: '0.0.0.0/0'
          FromPort: 1443
          ToPort: 1443
        - IpProtocol: tcp
          CidrIp: '0.0.0.0/0'
          FromPort: 8099
          ToPort: 8099
        - IpProtocol: tcp
          CidrIp: '0.0.0.0/0'
          FromPort: 4897
          ToPort: 4897
      SecurityGroupEgress:
        - IpProtocol: '-1'
          FromPort: -1
          ToPort: -1
          CidrIp: '0.0.0.0/0'
  ECSService:
    Type: AWS::ECS::Service
    Properties:
      Cluster: !Ref 'ECSCluster'
      LaunchType: EC2
      DeploymentController:
        Type: ECS
      DesiredCount: 0
      TaskDefinition: !Ref 'ECSTaskDefinition'
      ServiceName: !Sub '${AWS::StackName}ECSService'
  ECSCluster:
    Type: AWS::ECS::Cluster
    Properties:
      ClusterName: !Sub '${AWS::StackName}ECSCluster'
  ECSTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      ContainerDefinitions:
        - Name: edgeConnectorSiemens
          Image: softingindustrial/edgeconnector-siemens:v1-20
          Cpu: 1
          Hostname: s7sim
          PortMappings:
            - ContainerPort: 443
              HostPort: 1443
            - ContainerPort: 8099
              HostPort: 8099
            - ContainerPort: 4897
              HostPort: 4897
          Memory: 256
          Essential: true
          MountPoints:
            - SourceVolume: EdgeConnectorConfig
              ContainerPath: /config
      Volumes:
        - Host:
            SourcePath: /home/ec2-user/ecconf
          Name: EdgeConnectorConfig
  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: /
      Roles:
        - !Ref 'EC2InstanceRole'
  EC2InstanceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2008-10-17'
        Statement:
          - Sid: ''
            Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
                - ec2.amazonaws.com
                - s3.amazonaws.com
                - greengrass.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonEC2ContainerServiceforEC2Role
      Policies:
        - PolicyName: !Sub '${AWS::StackName}GreengrassPolicy'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: ''
                Effect: Allow
                Action:
                  - greengrass:CreateConnectorDefinitionVersion
                  - greengrass:ListFunctionDefinitions
                  - greengrass:ListFunctionDefinitionVersions
                  - greengrass:ListCoreDefinitionVersions
                  - greengrass:GetCoreDefinitionVersion
                  - greengrass:GetGroupVersion
                  - greengrass:ListConnectorDefinitionVersions
                  - greengrass:CreateGroupVersion
                  - greengrass:ListDeployments
                  - greengrass:ListConnectorDefinitions
                  - greengrass:ListGroupVersions
                  - greengrass:CreateCoreDefinition
                  - greengrass:AssociateRoleToGroup
                  - greengrass:CreateDeployment
                  - greengrass:CreateFunctionDefinition
                  - greengrass:CreateGroup
                  - greengrass:CreateFunctionDefinitionVersion
                  - greengrass:CreateCoreDefinitionVersion
                  - greengrass:ListCoreDefinitions
                  - greengrass:ListGroups
                  - greengrass:CreateConnectorDefinition
                  - greengrass:GetServiceRoleForAccount
                Resource: '*'
        - PolicyName: !Sub '${AWS::StackName}IAMPolicy'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: ''
                Effect: Allow
                Action:
                  - iam:GetRole
                  - iam:PassRole
                  - iam:ListRoles
                  - iam:CreateRole
                  - iam:PutRolePolicy
                Resource: '*'
        - PolicyName: !Sub '${AWS::StackName}IoTPolicy'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: ''
                Effect: Allow
                Action:
                  - iot:CreateRoleAlias
                  - iot:CreateThing
                  - iot:AttachPolicy
                  - iot:AttachThingPrincipal
                  - iot:CreatePolicy
                  - iot:ListPolicies
                  - iot:CreateKeysAndCertificate
                  - iot:ListThings
                  - iot:ListCertificates
                Resource: '*'
        - PolicyName: !Sub '${AWS::StackName}ECSPolicy'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: ''
                Effect: Allow
                Action:
                  - ecs:RunTask
                Resource: '*'
        - PolicyName: !Sub '${AWS::StackName}SiteWisePolicy'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: ''
                Effect: Allow
                Action:
                  - iotsitewise:CreateGateway
                  - iotsitewise:ListGateways
                  - iotsitewise:UpdateGatewayCapabilityConfiguration
                  - iotsitewise:DeleteGateway
                Resource: '*'
        - PolicyName: !Sub '${AWS::StackName}S3Policy'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: ''
                Effect: Allow
                Action:
                    - s3:GetObject
                Resource: '*'
Outputs:
  UAEndpoint:
    Description: Public default UA endpoint for access with AWS IoT SiteWise
    Value: !Join
      - ''
      - - opc.tcp://
        - !GetAtt 'ClassicLoadBalancer.DNSName'
        - :4897/Softing/dataFEED/Server
    Export:
        Name: !Sub '${AWS::StackName}-UAEndpoint'
  edgeConnectorSiemens:
    Description: Public link for secure access to edgeConnectorSiemens local administrator
      interface
    Value: !Join
      - ''
      - - http://
        - !GetAtt 'ClassicLoadBalancer.DNSName'
    Export:
        Name: !Sub '${AWS::StackName}-edgeConnectorSiemens'
  SiteWiseAsset:
    Description: AWS IoT SiteWise Asset into which data is published
    Value: !Sub '${AWS::StackName}S7SimAsset'
    Export:
        Name: !Sub '${AWS::StackName}-SiteWiseAsset'
